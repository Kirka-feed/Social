<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>You're Invited!</title>
  <meta property="og:title" content="You're Invited!" />
  <meta property="og:description" content="You've been invited. Join us now!" />
  <meta property="og:image" content="https://vectorified.com/images/google-sheets-icon-29.png" />
  <meta property="og:url" content="https://kirka-feed.github.io/Social/" />
  <meta property="og:type" content="website" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 2rem;
    }
    .card {
      background: #161b22;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      max-width: 500px;
      width: 100%;
      display: none;
    }
    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid #3f83f8;
      margin-bottom: 1rem;
      object-fit: cover;
    }
    h1 {
      color: #58a6ff;
    }
    .invite-text {
      font-size: 1.2rem;
      margin: 1rem 0 0.5rem;
    }
    #joinBtn {
      background: #238636;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
      display: none;
    }
    .note {
      color: #8b949e;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <div class="card" id="inviteCard">
    <img src="" class="avatar" alt="User Avatar" />
    <h1>You've Been Invited!</h1>
    <p class="invite-text"><strong></strong> invited you to join.</p>
    <button id="joinBtn">Join Now</button>
    <div class="note">Use the invite link provided to join the party!</div>
  </div>

  <script>
    // Helper: decode Base64 safely
    function safeBase64Decode(str) {
      try {
        return decodeURIComponent(atob(str).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
      } catch {
        return null;
      }
    }

    // Update meta tags dynamically in the head (only client-side)
    function updateMetaTags(userData) {
      const head = document.getElementsByTagName('head')[0];

      function setMetaProperty(prop, content) {
        let tag = document.querySelector(`meta[property='${prop}']`);
        if (!tag) {
          tag = document.createElement('meta');
          tag.setAttribute('property', prop);
          head.appendChild(tag);
        }
        tag.setAttribute('content', content);
      }

      setMetaProperty('og:title', `You're Invited by ${userData.User || 'Someone'}!`);
      setMetaProperty('og:description', `${userData.User || 'Someone'} invited you to join. Don't miss out!`);
      setMetaProperty('og:image', userData["user-image"] || 'https://vectorified.com/images/google-sheets-icon-29.png');
      setMetaProperty('og:url', window.location.href);
      setMetaProperty('og:type', 'website');
    }

    // Show invite card with user info
    function showInviteCard(userData) {
      const card = document.getElementById('inviteCard');
      card.style.display = 'block';

      const avatar = card.querySelector('.avatar');
      avatar.src = userData["user-image"] || 'https://via.placeholder.com/100';

      const inviterNameElem = card.querySelector('.invite-text strong');
      inviterNameElem.textContent = userData.User || 'Unknown';

      document.getElementById('joinBtn').style.display = 'inline-block';

      updateMetaTags(userData);
    }

    // Parse URL param "invitedby" which is base64 encoded username
    const params = new URLSearchParams(window.location.search);
    const encodedUser = params.get('invitedby');
    if (!encodedUser) {
      document.body.innerHTML = '<h2 style="color:#f85149;">Invalid or missing invite link.</h2>';
    } else {
      const decodedUser = safeBase64Decode(encodedUser);
      if (!decodedUser) {
        document.body.innerHTML = '<h2 style="color:#f85149;">Invalid invite user encoding.</h2>';
      } else {
        // Fetch Google Sheet data
        fetch('https://opensheet.elk.sh/1ikyDtsWpTu-CspRoKitH6nFtgnB8XPUXytJDc9Q1vO8/Sheet1')
          .then(res => res.json())
          .then(data => {
            const userData = data.find(entry => entry.User?.toLowerCase() === decodedUser.toLowerCase());
            if (userData) {
              showInviteCard(userData);
            } else {
              document.body.innerHTML = '<h2 style="color:#f85149;">User not found.</h2>';
            }
          })
          .catch(() => {
            document.body.innerHTML = '<h2 style="color:#f85149;">Error loading user data.</h2>';
          });
      }
    }

    // Join button click redirects to target page
    document.getElementById('joinBtn').addEventListener('click', () => {
      window.location.href = 'https://kirka-feed.github.io/Social/';
    });
  </script>

</body>
</html>
